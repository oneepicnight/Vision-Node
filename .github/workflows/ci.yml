name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test Suite (FULL-only)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache target directory
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Check formatting
        run: cargo fmt -- --check
      
      - name: Run clippy
        run: cargo clippy --all-targets -- -D warnings
        continue-on-error: true
      
      - name: Build (release)
        run: cargo build --release --locked
      
      - name: Run tests
        run: cargo test --all --locked
        env:
          RUST_LOG: info
      
      - name: Run doc tests
        run: cargo test --doc --locked

  build-ci-profile:
    name: Build with CI Profile (Warnings = Errors)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build with warnings as errors (MVP)
        run: cargo build --profile ci --locked
        env:
          RUSTFLAGS: "-D warnings"
        continue-on-error: true  # Don't fail CI yet while cleaning up warnings

  integration-test:
    name: Integration Tests
    runs-on: windows-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build release binary
        run: cargo build --release --locked
      
      - name: Start Vision Node
        run: |
          $env:VISION_ADMIN_TOKEN="ci-test-token"
          $env:VISION_PORT=7070
          $env:VISION_DATA_DIR="./vision_data_ci"
          Start-Process -FilePath ".\target\release\vision-node.exe" -NoNewWindow
          Start-Sleep -Seconds 10
        shell: powershell
      
      - name: Wait for node to be ready
        run: |
          $maxAttempts = 30
          $attempt = 0
          $ready = $false
          
          while ($attempt -lt $maxAttempts -and -not $ready) {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:7070/health" -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "Node is ready!"
                $ready = $true
              }
            } catch {
              Write-Host "Waiting for node... (attempt $($attempt + 1)/$maxAttempts)"
              Start-Sleep -Seconds 2
              $attempt++
            }
          }
          
          if (-not $ready) {
            Write-Error "Node failed to start within timeout"
            exit 1
          }
        shell: powershell
      
      - name: Run integration tests
        run: cargo test --test wallet_receipts -- --test-threads=1
        env:
          VISION_TEST_URL: "http://127.0.0.1:7070"
          VISION_ADMIN_TOKEN: "ci-test-token"
          RUST_LOG: debug
      
      - name: Cleanup
        if: always()
        run: |
          Get-Process | Where-Object { $_.Name -eq "vision-node" } | Stop-Process -Force
          Remove-Item -Recurse -Force "./vision_data_ci" -ErrorAction SilentlyContinue
        shell: powershell
      - name: Confirm dev signing endpoint not present
        run: |
          # Query the dev signing endpoint and ensure it's not exposed in MVP build. Exit 1 if it returns 2xx/3xx/5xx.
          try {
            $resp = Invoke-WebRequest -Uri "http://127.0.0.1:7070/wallet/sign" -TimeoutSec 5 -ErrorAction Stop
            # If we got here, the endpoint returned a 2xx or 3xx result -> fail
            Write-Error "Dev signing endpoint exposed: status $($resp.StatusCode)"
            exit 1
          } catch {
            # If the server returned 4xx (like 404/403), it's OK; otherwise, for other errors we also accept them.
            if ($_.Exception -and $_.Exception.Response) {
              $status = $_.Exception.Response.StatusCode.value__
              if ($status -ge 400 -and $status -lt 500) {
                Write-Host "Dev signing endpoint properly restricted: $status"
              } else {
                Write-Error "Unexpected response checking dev signing endpoint: $status"
                exit 1
              }
            } else {
              Write-Host "Dev signing endpoint not reachable (probably not exposed)"
            }
          }
        shell: powershell

  security-audit:
    name: Security Audit
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Run security audit
        run: cargo audit
        continue-on-error: true  # Advisory only
